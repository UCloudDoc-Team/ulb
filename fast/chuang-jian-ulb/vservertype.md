{{indexmenu_n>3}}

# VServer：监听器协议／类型

## 协议

ULB的协议分为四层协议和七层协议。四层协议包括TCP/UDP。七层协议包括HTTP和HTTPS。

### 四层协议(TCP／UDP)

根据IP地址加端口号来做负载均衡，进行处理后转发至后端服务节点。

* UDP协议：只需要根据服务IP地址与端口进行负载均衡，对可靠性要求不高，无需差错恢复和数据重传的业务。
* TCP协议：只需根据服务IP地址与端口进行负载均衡，对可靠性要求高，需要在传输数据前先进行握手，保证数据可靠性的业务。

### 七层协议(HTTP/HTTPS)

在四层的基础上，考虑应用层的特征，除了IP地址加端口还可根据七层的URL等信息来进行负载均衡。 

* HTTP协议：不但需要对服务IP地址与端口进行监听，还需要根据应用层内容进行负载均衡，如URL等，但对安全要求不高的业务。
* HTTPS协议：不但需要对服务IP地址与端口进行监听，还需要根据应用层内容进行负载均衡，如URL等，对安全要求高，需要加密的业务。

### 选择建议

* 若业务无需针对应用层的信息做负载均衡，仅需监听服务IP地址与端口，可选择四层ULB。
* 对性能要求较高，可选择四层ULB。
* 如需根据URL、域名等应用层信息来进行负载均衡，或需要HTTP的健康探测，或需要HTTPS SSL卸载，则可选择七层ULB。

## 监听器类型

监听类型分为报文转发和请求代理。报文转发支持的协议有TCP、UDP，请求代理支持的协议有HTTP、HTTPS、TCP。

### 使用HTTP请求代理和TCP请求代理模式的区别

TCP的请求代理做的工作是：接收请求，选择后端节点，连接后端节点，转发内容；可以将上层其他协议的报文直接转发至后端服务节点。

HTTP的请求代理的工作是：接收请求，解析请求，根据转发规则选择服务节点集群，根据ULB算法选择后端服务节点，连接服务节点，接收响应，解析响应头，添加适当的响应头（如Set-cookie等），返回响应内容给客户端。

### 使用TCP报文转发和TCP请求代理模式的区别

请求代理需要维护客户端到ULB和ULB到后端服务节点的两个TCP连接（需要经历两次TCP握手）。报文转发只需要对报文的解析和转发，少去了连接建立的开销，这样报文转发的效率高于请求代理模式多个数量级。

使用报文转发方式具有以下限制：

* TCP报文转发模式不能支持同一个后端服务节点监听不同的端口，请求代理模式下并无此限制。
* TCP报文转发模式的后端服务节点必须配置ULB的服务IP地址，而TCP的请求代理模式则无需此配置。

如无在一个服务节点上监听多个端口的需求，则可选择报文转发模式，转发性能占优。

[[https://github.com/UCloudDocs/UCloud-document/issues/3|{{https://static.ucloud.cn/e7fec9d74c744c448d757fad04fe1bcb.png}}]]

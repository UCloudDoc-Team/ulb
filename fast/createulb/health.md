# 健康检查

ULB健康检查可判断后端服务器是否正常，对于异常的后端服务器，ULB将其从后端服务器池中移除，客户端请求将会在其他服务器之间进行分发。对于处于异常状态的服务器恢复正常时，会被ULB恢复至后端服务器池中。

## 端口检查
ULB在每个可用区内部署专用服务器对会探测后端节点的IP+端口是否正常。探测频率为2s，连续三次探测失败后端服务器状态异常，连续三次探测正常，则后端服务器状态正常。注意：数据更新有6s延迟，故**健康检查状态或有6s延迟**。

所有协议均支持端口检查。但检测状态略有不同：HTTP、HTTPS以及TCP的请求代理模式的端口检查是用TCP进行探测。而TCP的报文转发模式及UDP协议则是使用选择的四层协议做端口探测。


## HTTP检查
通过HTTP HEAD请求检查后端服务器上的应用是否可用。要求后端服务器支持HEAD请求。

用户使用HTTP健康检查，需要配置HTTP检查路径（如果有必要的话，也可以配置HTTP的检查域名，一般不需要填写），两者拼接组成了HTTP检查的URL，ULB会对此URL发起HTTP HEAD请求，请求响应码为2xx或3xx则认为后端服务器正常。健康检查探测周期为2s，连续3次探测失败后端节点变更为不健康，连续两次正常变更为健康。

HTTP检查路径，最多为227个字符，直接填写域名或IP地址后的相对路径文件。可以选择首页、出现异常概率较小的页面、专门为健康检查准备的空文件（HTTP HEAD请求可以获得200的响应码即可），选择首页可能会加大服务器压力，不建议选择首页作为HTTP健康检查的域名和路径。

HTTP检查域名，不建议填写"http:"或"https:"，直接填写域名或IP地址即可。支持主域名、二级域名等多级域名。

## Ping探测

健康检查成功：在响应超时时间内（5s）收到响应的UDP报文；在响应超时时间内未收到任何报文且ping检测正常。

健康检查失败：在响应超时时间内（5s）收到 ICMP Unreachable 差错报文


## 不同类型VServer支持的健康检查方式
|ULB类型|VServer监听协议|健康检查方式|说明|
|---|---|---|---|
|请求代理|HTTPS/HTTP|端口检查|使用TCP进行端口探测|
|请求代理|HTTPS/HTTP|HTTP检查|HTTP HEAD请求检查，可探测服务是否存活
|请求代理|TCP|端口检查|使用TCP进行端口探测|
|报文转发|TCP|端口检查|使用TCP进行端口探测|
|报文转发|UDP|Ping探测|Ping监听端口检查
|报文转发|UDP|端口检查|使用UDP进行端口探测|

> 端口检查和Ping探测仅能保证所探测的端口是存活的



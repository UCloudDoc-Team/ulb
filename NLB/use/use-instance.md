# 最佳实践

## 使用NLB挂载跨地域VPC的服务节点

应用型负载均衡NLB支持跨地域挂载的功能。本文指导您使用NLB和云联网UGN搭配，使NLB将请求转发至其他地域的服务器中。

### 前提条件

- 您已在广州地域创建了私有网络VPC1，在上海二创建了私有网络VPC2。
- 您已在VPC1中创建了一个NLB实例。
- 您已在VPC2中创建一个Uhost实例，并部署了业务。

### 配置流程

1. #### **创建云联网实例**

   1. 登录[云联网控制台](https://console.ucloud.cn/ugn/)。
   2. 点击创建**云联网实例**。
   3. 输入云联网实例名称，并将已经创建好的VPC1和VPC2添加到当前实例下。
      ![图片注释](/images/ULB_UGN实例.png)
   4. 进入创建好的云联网实例页，选择**带宽包**页签；
       ![图片注释](/images/ULB_UGN购买带宽包.png)
   5. 购买广州到上海二的带宽包。
      ![图片注释](/images/ULB_UGN购买带宽包实例.png)

2. #### **添加监听器**

   1. 在顶部导航栏中，选择创建NLB实例的所在地域。
   2. 选择以下一种方法，打开监听配置。
      1. 在**实例列表**页面，在目标实例**操作**列点击**监听器管理**。
      2. 在**实例列表**页面，点击目标实例ID或者详情。在**监听器管理**页签，点击**添加监听**。
         ![图片注释](/images/添加监听器.png)
      
   3. 在**创建监听器**页面，完成以下配置，然后点击**确认**。


| 配置项       | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 协议         | 选择监听的协议类型，本示例选择TCP                            |
| 端口         | 输入用来接收请求并向后端服务器进行请求转发的监听端口，端口范围为1~65535。同一个NLB实例内，监听端口不能重复，本示例选择80端口 |
| 负载均衡算法 | 选择一种负载均衡的调度算法，本示例选择轮询算法，是将用户的请求轮流分配给后端服务器。 |
| 服务会话保持 | 选择是否开启或关闭会话保持。默认情况下，NLB会将每个客户端请求分别分发至不同的后端服务器上。当您开启了会话保持功能后，会话保持可以使来自同一客户端的请求被转发至同一台后端服务器上，方便后端服务器维护状态信息及向客户端提供持续体验； |
| 节点健康检查 | 选择节点健康检查的方式，本示例选择端口检查，使用后端服务器的端口进行健康检查。 |
| 监听器名称   | 输入监听器名称。                                             |
| 备注         | 输入监听器的备注信息。                                       |

3. #### 添加服务节点

   1. 进入**监听器管理**页签，点击添加节点。
      ![图片注释](/images/NLB添加节点.png)
   
   2. 完成如下配置。


| 配置项   | 说明                            |
| :------- | :------------------------------ |
| 资源类型 | 选择内网IP资源类型              |
| 地域     | 选择上海地域                    |
| 所属VPC  | 选择上海地域创建的VPC2          |
| 监听端口 | 80                              |
| 资源     | 输入VPC2中创建Uhost实例的内网IP |

4. #### 测试连通性

   1. 访问NLB的外网IP地址；
   2. 查看能否访问到部署在上海Uhost中的业务；


### 注意事项

- NLB跨地域挂载的后端服务器仅支持IP类型。
- VPC1和VPC2需要加入同一个云联网中。
- 不支持转发路径存在环路的场景。如果发现环路时，为避免网络资源被耗尽，NLB对该实例进行迁移，同时不在保证环路实例的可用性。
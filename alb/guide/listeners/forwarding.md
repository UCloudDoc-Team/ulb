# 内容转发

监听器支持根据内容转发规则匹配域名或访问路径，能够将匹配请求转发到后端特定主机，对后端服务节点进行精细化管理，内容转发规则分为 "域名转发" 与 "路径转发" 两种，这两种转发方式均可以使用符合PCRE规则的正则表达式进行描述，如"www.[123].demo.com"，“.*.demo.com” 或 "/path/img/.*.jpg" ,创建规则时规则内容不可为空，不可包含转义符。

# 添加内容转发规则

默认情况下，会存在一条Default的规则策略，该策略在所有请求均未匹配成功时生效，会匹配到Default规则进行转发。

1. 登录应用型负载均衡ALB控制台。
2. 在顶部菜单栏，选择ALB实例的所属地域。
3. 选择以下一种方法，打开监听配置。
   1. 在**实例列表**页面，在目标实例**操作**列点击**监听器管理**。
   2. 在**实例列表**页面，点击目标实例ID或者详情。在**监听器管理**页签，进入监听器详情页。
4. 在**监听器详情**页面，选择**内容转发**页签。

![1713863805889](/images/1713863805889.png)

​	5. 点击左上角添加规则，在添加规则页编辑如下内容。

|            |                                                              | 说明                                                         |
| :--------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| 转发类型   | 域名转发                                                     | 转发域名长度限制不超过255个字符，且单级长度不超过63个字符；<br>正则表达式支持中文、字母、数字和特殊字符. - ? = ~ _ - + ^ * ! $ : & \| ( ) [ ]。（其中“:”只能用在域名后面加端口的形式，用在非80端口的HTTP和非443端口的HTTPS场景中）<br;>通配域名支持中文、字母、数字和特殊字符. : * _ -。<br>_ 不能出现在开头或结尾。<br>通配域名，目前仅支持 * . 或 . 在开头或者 . * 或 . 在结尾，且单个域名中仅支持 * 出现一次。 |
| 路径转发   | 1-255个字符。支持中文、字母、数字和特殊字符. - _ / = ? ^ * $ ! : ( ) [ ] + \| | 1-255个字符。 <br>支持中文、字母、数字和特殊字符. - _ / = ? ^ * $ ! : ( ) [ ] + \| |
| 转发条件   | 正则                                                         | 支持正则表达式，例：www.[123].demo.com 可匹配 [www.1.demo.com](http://www.1.demo.com/) 、 [www.2.demo.com](http://www.2.demo.com/) 、[www.3.demo.com](http://www.3.demo.com/) 等域名。 |
|            | 泛解析                                                       | 支持通配符匹配，例：*.demo.com 或 .demo.com 可匹配所有以demo.com结尾的域名，[www.demo](http://www.demo/).* 或 [www.demo](http://www.demo/). 可匹配所有以[www.demo](http://www.demo/) 开头的域名。<br>/path/img/.*.jpg 可匹配 /path/img/路径下所有以jpg结尾的文件，例如/path/img/demo.jpg、/path/img/1/demo.jpg等。 |
| 自定义动作 |                                                              | **写入Header**：输入键和支的内容，将覆盖请求中已有的头变量。<br/>**删除Header**：选择需要删除的Header头，将删除请求Header中的该键值对内容支持删除X-Real-IP，X-Forwarded-For，X-Forwarded-Proto，X-Forwarded-SrcPort的Header头 <br/>**跨域**：客户端发送的请求URL的协议、域名或者端口三者之间任意一个与当前返回的页面URL不同即为跨域。请求包括简单请求和预检请求。  <br/>**允许跨域的访问来源**：设置允许通过浏览器访问服务资源的站点。 <br/>**允许跨域的HTTP方法**：选择跨域访问时允许的HTTP方法。包括：**GET**，**POST**、**PUT**、**DELETE**、**HEAD**、**OPTIONS**、**PATCH**。 <br/>**允许的跨域的Header**：除了浏览器内置的基础Header，设置跨域访问时允许的Header。 <br/>**允许暴露的 Header**：允许浏览器、JavaScript脚本访问的响应头部。 <br/>**是否允许携带凭证**：跨域访问时是否允许携带的凭证信息。取值：**允许**或**不允许**，默认**允许**。 <br/>**浏览器缓存时间**：对于预检请求，设置OPTIONS预检请求在浏览器的最大缓存时间。单位：秒。取值范围：**-1~172800**。<br/>**关闭缓存**：ALB 收到请求后，立即转发给后端服务节点，不再缓存。 |
| 最终动作   |                                                              | **转发至**：在服务节点列表中选择目标节点。 <br/>**返回固定响应**：输入**响应状态码**，然后选择填写**响应正文**。响应状态码必须是2xx、4xx、5xx的数字型字符串，x为任意数字。 |

![1713864072070](/images/1713864072070.png)

	6. 点击确定，即可完成内容转发规则的配置。

# 管理内容转发规则

在添加内容转发规则后，支持编辑当前规则关联的节点或者动作。

1. 登录应用型负载均衡ALB控制台。
2. 在顶部菜单栏，选择ALB实例的所属地域。
3. 选择以下一种方法，打开监听配置。
   1. 在**实例列表**页面，在目标实例**操作**列点击**监听器管理**。
   2. 在**实例列表**页面，点击目标实例ID或者详情。在**监听器管理**页签，进入监听器详情页。
4. 在**监听器详情**页面，选择**内容转发**页签，进入内容转发页。
5. 选择需要编辑的内容转发规则，点击操作列的**管理**，进入规则编辑页。

![1713864872618](/images/1713864872618.png)

​	6 .支持编辑规则的转发类型和转发内容以及动作。

# 删除内容转发规则

在添加内容转发规则后，支持编辑当前规则关联的节点或者动作。

1. 登录应用型负载均衡ALB控制台。
2. 在顶部菜单栏，选择ALB实例的所属地域。
3. 选择以下一种方法，打开监听配置。
   1. 在**实例列表**页面，在目标实例**操作**列点击**监听器管理**。
   2. 在**实例列表**页面，点击目标实例ID或者详情。在**监听器管理**页签，进入监听器详情页。
4. 在**监听器详情**页面，选择**内容转发**页签，进入内容转发页。
5. 选择需要删除的内容转发规则。

![1713865773573](/images/1713865773573.png)

6. 点击操作列的删除，或者左上角的删除规则。

7. 在删除规则二次确认弹窗中，点击确定，即可删除规则。

# 匹配策略

**转发规则优先级**：匹配策略按照转发规则添加的时间，进行排序，优先级从高到低，添加规则的时间越晚，优先级越高。

如果不同的转发规则中配置了相同的域名，会把相同域名的规则进行聚合，统一按该域名设置的最高优先级规则进行匹配和转发。

如果请求匹配域名后，但规则未配置请求的路径信息，则ALB会给客户端返回404.

**默认转发规则**：创建监听器后，系统会自动创建一条默认转发规则，该转发规则匹配所有客户端请求；转发到设置的后端服务节点。

**默认转发规则说明：**默认转发规则不支持删除，支持更改转发的后端服务节点。默认转发规则的优先级最低。
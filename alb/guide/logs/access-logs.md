# 访问日志

ALB通常作为业务的首要访问入口，承载着庞大的访问请求流量。ALB会实时将业务日志投递至US3、Kafka、ElasticSearch等服务，通过分析业务日志，可以让您能够深入了解客户端的访问行为、地域分布特点。有助于更全面地了解用户的使用习惯，更能协助你高效排查和解决潜在的故障问题。

# 费用说明

开启访问日志功能本身并不收费，但ALB将日志投递到指定日志收集端后由日志收集端进行收费，如US3会收取存储空间，和请求数量和读取流量的费用。

# 开启访问日志

1. 登录应用型负载均衡ALB控制台。
2. 在顶部导航栏，选择ALB实例所属的地域。
3. 在**实例**页面，点击目标实例ID。
4. 在**实例详情**页，选择概览页签，选择左侧日志管理。

![img](/images/93f81a4c-04da-4467-a787-9865598b26bd.png)

1. 选择开启访问日志，选择投递方式

| 投递方式      | 配置                                          | 使用限制                                                     |
| :------------ | :-------------------------------------------- | :----------------------------------------------------------- |
| US3           | 选择创建的US3存储空间，和US3令牌              | 仅支持US3上线的地域开启访问，详情请查看[US3地域](https://docs.ucloud.cn/ufile/introduction/region)。 |
| ElasticSearch | 输入ES的IP及端口，支持输入多个IP和端口        |                                                              |
| Logstash      | 输入ES的IP及端口，支持输入多个IP和端口        |                                                              |
| Kafka         | 输入ES的IP及端口和Topic，支持输入多个IP和端口 |                                                              |
| ULogService   | 选择创建的主题和令牌                          |                                                              |

1. 开启自定义日志，支持自定义日志格式和日志内容。

| **字段**               | **说明**                                                     |
| :--------------------- | :----------------------------------------------------------- |
| request_id             | 请求的ID                                                     |
| server_protocol        | HTTP协议的版本，例如HTTP/1.0或HTTP/1.1                       |
| alb_id                 | 负载均衡实例ID                                               |
| user_agent             | 请求报文中HTTP的user-agent header的内容                      |
| referer                | 请求报文中HTTP的referer header的内容                         |
| x_forwarded_for        | 请求报文中x-forwarded-for的内容                              |
| request_length         | 请求报文的长度，请求本身的字节数                             |
| bytes_sent             | ALB 实例发送给客户端的数据的字节数                           |
| tcpinfo_rtt            | 表示客户端与 ALB 实例建立 TCP 连接过程的往返时间（RTT），单位为毫秒 |
| server_addr            | ALB的内网IP                                                  |
| server_port            | ALB的监听端口                                                |
| ssl_protocol           | 请求使用的 SSL 协议的版本                                    |
| ssl_cipher             | 请求使用的 SSL 加密套件                                      |
| request_time           | ALB 实例响应客户端请求的时长，即请求的处理时间，包括客户端发送请求到 ALB 实例，ALB 实例将请求转发到后端服务器，后端服务器将响应数据返回给 ALB 实例，ALB 实例转发数据到客户端 |
| remote_addr            | 客户端IP地址                                                 |
| remote_port            | 客户端端口                                                   |
| request_method         | 客户端发送请求的方法                                         |
| upstream_status        | 负载均衡收到的后端服务器的响应状态码                         |
| upstream_response_time | 后端服务器响应客户端请求所耗费的时间。即从 ALB 实例开始连接后端服务器到后端服务器响应结束所耗费的时间，单位：毫秒 |
| x_real_ip              | 请求报文中x-real-ip的内容                                    |
| request_uri            | 负载均衡收到的请求报文的URI                                  |
| status                 | 负载均衡应答报文的状态                                       |
| time_local             | 访问的时间与时区                                             |
| upstream_addr          | 处理该请求的后端服务器的 IP 地址和端口号。 如果请求没有发送到 target，该字段会记录 <NOSRV> |
| upstream_connect_time  | ALB 实例与后端服务器建立 TCP 连接所花费的时间。即从 ALB 实例开始连接后端服务器到 ALB 实例开始发送 HTTP 请求之间的耗费的时间，单位为秒 |
| upstream_header_time   | ALB 实例收到后端服务器响应头所花费的时间。即从 ALB 实例开始连接后端服务器到 ALB 实例接收完后端服务器的响应头所耗费的时间，单位为秒 |
| request                | 请求内容                                                     |
| host                   | 按以下优先顺序：请求行中的主机名，或“Host”请求标头字段中的主机名，或与请求匹配的服务器名称 |

# 修改/删除访问日志

1. 登录应用型负载均衡ALB控制台。
2. 在顶部导航栏，选择ALB实例所属的地域。
3. 在**实例**页面，点击目标实例ID。
4. 在**实例详情**页，选择概览页签，选择点击日志管理的编辑按钮。
5. 可以在日志管理弹窗，关闭日志功能，或调整投递方式修改自定义日志内容。